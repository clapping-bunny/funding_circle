---
title: "Visualising the funding circle loanbook"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This is the first in a series of blog posts looking at P2P lenders, which will be aimed at surfacing more details about the structures of their loanbooks. I hope to expand this series by looking at optimal strategies, predictive modelling, and interative data science.

Since 2005, with the launch of [Zopa](www.zopa.co.uk) P2P companies have provided a middle path between cash holdings, and investing in stocks and shares. Funding circle, which was launched in 2010, has currently faciliated over £1 Billion in loans to British businesses. It has also returned on average 6.6% after the exclusion of bad debt, fees etc.

The platform offers small, and medium businesses loans of up to £1 million, for up to 60 months. Whole or fractional loans are then purchased by individuals/insitutions. Since September 2015 loans have been offered with fixed rates determined by FC using the risk category of the company, and the loan terms. There is also a secondary market where individuals can sell loan parts, for a 0.25% fee, at a premium, at parity, or at a discount. Prior to September 2016 loans were auctioned with no fixed rate. 

FC allows the invester to hand pick each loan that they invest in, and the level of your exposure. However investors can also use an automated autobid tool that automatically buys loans, on both the primary and secondary markets, based on preset options specified by the investor. These include selecting risk levels to lend to, selecting rates to buy loans on the secondary market, and specifying a target maximum expoure to any single loan. These two system lead to a tension, with those that are handpicking loans being potentially able to manipulate the autobid algorithm acting for other investors. As part of this blog series I will be looking further into these strategies. 

Now for some simple visualisations of the FC loanbook, with the first step being to load the required packages (unhash for first run). 

```{r packages, message=FALSE}
#install.packages('tidyverse')
library(tidyverse)

#install.packages('lubridate')
library(lubridate)

#install.packages('stargazer')
library(stargazer)
```

Now to load in the data and dispaly the variable names:

```{r load loanbook, message=FALSE}
## File path of loanbook 
df_path  <- '~/data/Funding_circle/loanbook.csv'

## Load data with miss spec as N/A
loanbook <- read_csv(df_path, na='N/A')

## Restrict post september 2015
loanbook <- loanbook %>% filter(loan_accepted_date > '2010-10-01')

## var to factors
factor_list <- c('status', 'credit_band', 'loan_purpose', 'sector', 'business_type_name', 'region_name', 'whole_loan', 'repayment_type', 'security_taken')
                 
                 
format_factors <- function(factor_list, df){
                   for (var in factor_list)
                   {
                     df[[var]] <- factor(df[[var]])
                   }
                   
                   return(df)
}
loanbook <- format_factors(factor_list, loanbook)
```

We print the simple summary of the data as a first step (hidden for brevity). 
```{r loanbook summary, eval=FALSE}
summary(loanbook)
```
As the loanbook has evolved with time an immediate question is how the number of loans, at each risk level has changed with time. Across all risk bands we see that year on year loan acceptances have increased, with 2016 showing by far the largest growth. Notably we see the introduction of D loans in 2013, and the introduction of E loans in 2015. The vast majority of funding circle loans are with 'low risk' borrowers (i.e A, and A+), although the number of risky loans is now greater than the entire loanbook in 2014
 
 ```{r offer year}
 #Plot incidence - by year
loanbook %>% 
    mutate(year = floor_date(loan_accepted_date, "year")) %>%
        ggplot(aes(x=year, fill=credit_band)) + 
          geom_bar()
```

We now aggregate by month so that we can understand patterns of loan acceptances across the risk bands. For all risk bands we see that september and march have the highest number of loan acceptances, indicating that this may be a good time to more new funds into FC, and consequently lead to a slow down in the secondary market. E loans show strong growth in the second half of the year - however this may be an artifact of their relatively recent introduction, which maybe responsible for this apparent trend. 

```{r monthly risk band}
##Restrict data to pre 2016-10-01 to provide a comparable timespan

loanbook %>%
      filter(loan_accepted_date < '2016-10-01') %>% 
        mutate(month = month(loan_accepted_date, label=TRUE)) %>%
        ggplot(aes(x=month)) + 
          geom_bar() + 
            facet_wrap(~credit_band, scale='free') + 
            theme(axis.text.x = element_text(angle=90))
```

Finally we aggregate by day. There is limited evidence here that loan acceptances vary between weekdays, with a slight upward tick mid week.

```{r daly risk band}
##Restrict data to pre 2016-10-01 to provide a comparable timespan

loanbook %>%
        mutate(day = wday(loan_accepted_date, label=TRUE)) %>%
        ggplot(aes(x=day)) + 
          geom_bar() + 
            facet_wrap(~credit_band, scale='free') + 
            theme(axis.text.x = element_text(angle=90))
```



